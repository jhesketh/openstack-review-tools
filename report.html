<html>
<head>
<title>OpenStack code reviews</title>

<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
<script type="text/javascript" src="http://code.highcharts.com/highcharts.js"></script>
<script type="text/javascript" src="http://code.highcharts.com/modules/exporting.js"></script>

<script type="text/javascript">
var chart;

$(function () {
    $(document).ready(function() {
        Highcharts.setOptions({
            global: {
                useUTC: false
            }
        });
    });
});

function GenerateChart(data) {
    chart = new Highcharts.Chart({
        chart: {
            renderTo: 'container',
            type: 'spline',
            marginRight: 10,
        },
        title: {
            text: 'Code reviews'
        },
        xAxis: {
            type: 'datetime',
            tickPixelInterval: 150
        },
        yAxis: {
            title: {
                text: 'Reviews'
            },
        },
        tooltip: {
            formatter: function() {
                    return '<b>'+ this.series.name +'</b><br/>'+
                    Highcharts.dateFormat('%Y-%m-%d', this.x) +'<br/>'+
                    Highcharts.numberFormat(this.y, 2);
            }
        },
        legend: {
            enabled: true
        },
        exporting: {
            enabled: false
        },
        series: data
    });
}

</script>
</head>

<body>
<div id="container" style="min-width: 400px; height: 800px; margin: 0 auto"></div>

<script type="text/javascript">
var xmlhttp;
var newbody = "";
var responsepos = 0;

var users = [];
var initial = {};

xmlhttp = new XMLHttpRequest();
xmlhttp.onreadystatechange = function() {
    if (xmlhttp.readyState == 3) {
      try {
        newdata = xmlhttp.responseText.substr(responsepos);
        newline = newdata.indexOf('\n');

        while (newline > -1 ) {
          packetjson = newdata.substr(0, newline);
          packet = JSON.parse(packetjson);

          // Decode packet
          switch(packet.type) {
            case "users-present":
              for (i=0; i < packet.payload.length; i++) {
                console.log("Create user: " + packet.payload[i])
                initial[packet.payload[i]] = [];
              }
              users = packet.payload;
              break;

            case "initial-user-summary":
              console.log("Initial user entry: " + packet.user + ", " + packet.day + ", " + packet.payload.__total__);
              var day = new Date(packet.day);
              initial[packet.user].push([day.getTime(), packet.payload.__total__]);
              break;

            case "initial-user-summary-ends":
              console.log("Draw graph");

              var series = [];
              for (i=0; i < users.length; i++) {
                series.push({'name': users[i],
                             'data': initial[users[i]]})
              }

              GenerateChart(series);
              break;

            case "update-user-summary":
              console.log("Update user entry: " + packet.user + ", " + packet.day + ", " + packet.payload.__total__);
              var day = new Date(packet.day);
              chart.series[0].addPoint([day.getTime(), packet.payload.__total__], true, true);
              break;

            case "keepalive":
              console.log("Connection still alive");
              break;

            case "debug":
              console.log("From server: " + packet.payload);
              break;

            default:
              console.log("Unknown packet!");
              console.log(packet);
              break;
          }

          newdata = newdata.substr(newline + 1);
          responsepos = responsepos + newline + 1;
          newline = newdata.indexOf('\n');
        }
      }
      catch(err) {
        console.log("Error: " + err);
      }
    }
}

xmlhttp.open("GET", "http://openstack.stillhq.com/reviews/summaryfeed.cgi", true);
xmlhttp.send();
</script>
</body>
</html>
